From 774b163f77a46b8f0cdd65a6cd02b9227525b743 Mon Sep 17 00:00:00 2001
From: Tanel Dettenborn <tanel@ssrc.tii.ae>
Date: Wed, 12 Mar 2025 14:37:16 +0200
Subject: [PATCH] ARM-SMMU drivers return always true for
 IOMMU_CAP_CACHE_COHERENCY capability

Signed-off-by: Tanel Dettenborn <tanel@ssrc.tii.ae>
---
 drivers/iommu/arm/arm-smmu/arm-smmu.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/iommu/arm/arm-smmu/arm-smmu.c b/drivers/iommu/arm/arm-smmu/arm-smmu.c
index 42c5012ba8aa..80d4d018a09a 100644
--- a/drivers/iommu/arm/arm-smmu/arm-smmu.c
+++ b/drivers/iommu/arm/arm-smmu/arm-smmu.c
@@ -1319,9 +1319,19 @@ static bool arm_smmu_capable(struct device *dev, enum iommu_cap cap)
 		 * walk interface is connected to a coherent interconnect, all the
 		 * translation interfaces are too. Furthermore if the device is
 		 * natively coherent, then its translation interface must also be.
+		 *
+		 * return cfg->smmu->features & ARM_SMMU_FEAT_COHERENT_WALK ||
+		 *	 device_get_dma_attr(dev) == DEV_DMA_COHERENT;
 		 */
-		return cfg->smmu->features & ARM_SMMU_FEAT_COHERENT_WALK ||
-			device_get_dma_attr(dev) == DEV_DMA_COHERENT;
+
+		/*
+		 * TODO: A nice comment
+		 * - VFIO-PCI
+		 * - linux kernel 5.15
+		 * - NVIDIA HW not changed from 5.15 -> 6.6.
+		 * - Unseen issues
+		 */
+		return true;
 	case IOMMU_CAP_NOEXEC:
 	case IOMMU_CAP_DEFERRED_FLUSH:
 		return true;
-- 
2.47.2

